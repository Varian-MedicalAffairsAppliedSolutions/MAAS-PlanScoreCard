using Newtonsoft.Json;
using PlanScoreCard.Models.ModelHelpers;
using PlanScoreCard.Services;
using Prism.Mvvm;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;

namespace PlanScoreCard.Models
{
    public class StructureModel : BindableBase, INotifyPropertyChanged
    {

        private string structureId;

        public string StructureId
        {
            get { return structureId; }
            set
            {
                structureId = value;

                //if(String.IsNullOrWhiteSpace(structureId))
                //    TemplateStructureId = structureId;

                NotifyPropertyChanged();
            }
        }

        private string structureComment;

        public string StructureComment
        {
            get { return structureComment; }
            set
            {
                structureComment = value;
                NotifyPropertyChanged();
            }
        }

        private string templateStructureId;

        public string TemplateStructureId
        {
            get { return templateStructureId; }
            set
            {
                templateStructureId = value;
                NotifyPropertyChanged();
            }
        }

        public string StructureCode { get; set; }
        public bool AutoGenerated { get; set; }
        #region structure validation
        private bool _bValidStructure;
        [JsonIgnore]
        public bool bValidStructure
        {
            get { return _bValidStructure; }
            set { SetProperty(ref _bValidStructure, value); }
        }
        private bool _bStructureMatch;
        [JsonIgnore]
        public bool bStructureMatch
        {
            get { return _bStructureMatch; }
            set { SetProperty(ref _bStructureMatch, value); }
        }
        private bool _bDictionaryMatch;
        [JsonIgnore]
        public bool bDictionaryMatch
        {
            get { return _bDictionaryMatch; }
            set { SetProperty(ref _bDictionaryMatch, value); }
        }
        [JsonIgnore]
        public ObservableCollection<StructureModel> PlanStructureMatches { get; private set; }
        private StructureModel _matchedStructure;
        [JsonIgnore]
        public StructureModel MatchedStructure
        {
            get { return _matchedStructure; }
            set { SetProperty(ref _matchedStructure, value); }
        }

        #endregion
        public StructureModel()
        {
            PlanStructureMatches = new ObservableCollection<StructureModel>();
        }


        public event PropertyChangedEventHandler PropertyChanged;
        // This method is called by the Set accessor of each property.
        // The CallerMemberName attribute that is applied to the optional propertyName
        // parameter causes the property name of the caller to be substituted as an argument.
        private void NotifyPropertyChanged([CallerMemberName] String propertyName = "")
        {
            if (PropertyChanged != null)
            {
                PropertyChanged(this, new PropertyChangedEventArgs(propertyName));
            }
        }
        public void EvaluateStructureMatch(List<StructureModel> planStructures)
        {
            foreach (var structure in planStructures)
            {
                PlanStructureMatches.Add(structure);
            }
            if (planStructures.Any(ss => ss.structureId.Equals(this.StructureId, StringComparison.OrdinalIgnoreCase)))
            {
                MatchedStructure = planStructures.FirstOrDefault(ss => ss.StructureId.Equals(this.StructureId, StringComparison.OrdinalIgnoreCase));
                bStructureMatch = true;
                bValidStructure = true;
                //return StructureMatchWarningModel.None;
                return;
            }
            //check dictionary if structure exists.
            StructureDictionaryService localStructureDictionary = new StructureDictionaryService();
            //foreach (var structure in planStructures)
            //{
            var structureEntry = localStructureDictionary.StructureDictionary.FirstOrDefault(sd => sd.StructureID.Equals(this.StructureId, StringComparison.OrdinalIgnoreCase));
            if (structureEntry != null)
            {
                foreach (var structure in planStructures)
                {
                    var localStructureMatch = localStructureDictionary.FindMatch(structure.StructureId);
                    if (String.IsNullOrEmpty(localStructureMatch))
                    {
                        MatchedStructure = structure;
                        bValidStructure = true;
                        bDictionaryMatch = true;
                        return;
                        //return StructureMatchWarningModel.Warning;
                    }
                }
            }
            // return StructureMatchWarningModel.Flag;
        }


    }
}
